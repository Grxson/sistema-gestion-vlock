# Reportes por Semanas - Implementaci√≥n Completada

## üéØ **Objetivo**

Crear una tabla detallada de reportes por semanas que permita ver el total generado de n√≥minas pagadas organizadas por semana del mes, con filtros por per√≠odo y a√±o para facilitar la navegaci√≥n a trav√©s de muchos meses de datos.

## üîß **Problema Identificado**

El sistema manejaba n√≥minas por semanas (Semana 1, Semana 2, Semana 3, etc.) pero no hab√≠a una forma f√°cil de:
- **Ver el desglose** por semanas de diferentes meses
- **Navegar** a trav√©s de muchos meses de datos
- **Filtrar** por per√≠odos espec√≠ficos
- **Ver totales** consolidados por semana

### **‚ùå Antes**
```
Reportes de N√≥minas
‚îú‚îÄ‚îÄ Resumen Semanal (solo semana actual)
‚îú‚îÄ‚îÄ Gr√°ficas
‚îú‚îÄ‚îÄ Lista de Pagos
‚îî‚îÄ‚îÄ Tabla Detallada (sin agrupaci√≥n por semanas)
```

**Problemas:**
- **No hab√≠a agrupaci√≥n** por semanas del mes
- **Dif√≠cil navegar** entre muchos meses
- **No hab√≠a filtros** por per√≠odo espec√≠fico
- **No se ve√≠an totales** por semana

## ‚úÖ **Soluci√≥n Implementada**

### **Mejora 1: Nueva Pesta√±a "Reportes por Semanas"**
```javascript
// ‚úÖ Nueva pesta√±a agregada
const tabs = [
  { id: 'summary', name: 'Resumen Semanal', icon: CalendarIcon },
  { id: 'charts', name: 'Gr√°ficas', icon: ChartBarIcon },
  { id: 'payments', name: 'Lista de Pagos', icon: UserGroupIcon },
  { id: 'weekly-reports', name: 'Reportes por Semanas', icon: TableCellsIcon }, // ‚Üê NUEVA
  { id: 'detailed', name: 'Tabla Detallada', icon: DocumentTextIcon }
];
```

### **Mejora 2: Estados para Filtros**
```javascript
// ‚úÖ Estados para reportes por semanas
const [weeklyReportsData, setWeeklyReportsData] = useState(null);
const [selectedPeriod, setSelectedPeriod] = useState('');
const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
```

### **Mejora 3: Funci√≥n de C√°lculo de Reportes**
```javascript
// ‚úÖ Funci√≥n calculateWeeklyReportsData
const calculateWeeklyReportsData = () => {
  // Funci√≥n para calcular semana del mes (mismo algoritmo que el wizard)
  const calcularSemanaDelMes = (fecha) => {
    const a√±o = fecha.getFullYear();
    const mes = fecha.getMonth();
    const dia = fecha.getDate();
    
    const primerDiaDelMes = new Date(a√±o, mes, 1);
    const diaPrimerDia = primerDiaDelMes.getDay();
    const diasEnPrimeraFila = 7 - diaPrimerDia;
    
    if (dia <= diasEnPrimeraFila) {
      return 1;
    } else {
      const diasRestantes = dia - diasEnPrimeraFila;
      const semanaDelMes = 1 + Math.ceil(diasRestantes / 7);
      
      const ultimoDiaDelMes = new Date(a√±o, mes + 1, 0);
      const diasEnElMes = ultimoDiaDelMes.getDate();
      const diasRestantesTotal = diasEnElMes - diasEnPrimeraFila;
      const filasAdicionales = Math.ceil(diasRestantesTotal / 7);
      const totalFilas = 1 + filasAdicionales;
      
      return Math.max(1, Math.min(semanaDelMes, totalFilas));
    }
  };

  // Filtrar n√≥minas por per√≠odo y a√±o si est√°n seleccionados
  let nominasFiltradas = nominas;
  
  if (selectedPeriod) {
    const [a√±o, mes] = selectedPeriod.split('-').map(Number);
    nominasFiltradas = nominasFiltradas.filter(nomina => {
      const fechaNomina = new Date(nomina.fecha_creacion || nomina.createdAt || nomina.fecha);
      return fechaNomina.getFullYear() === a√±o && fechaNomina.getMonth() === (mes - 1);
    });
  } else if (selectedYear) {
    nominasFiltradas = nominasFiltradas.filter(nomina => {
      const fechaNomina = new Date(nomina.fecha_creacion || nomina.createdAt || nomina.fecha);
      return fechaNomina.getFullYear() === selectedYear;
    });
  }

  // Agrupar por per√≠odo y semana
  const reportesPorSemana = {};
  
  nominasFiltradas.forEach(nomina => {
    const fechaNomina = new Date(nomina.fecha_creacion || nomina.createdAt || nomina.fecha);
    const a√±o = fechaNomina.getFullYear();
    const mes = fechaNomina.getMonth() + 1;
    const semanaDelMes = calcularSemanaDelMes(fechaNomina);
    
    const periodo = `${a√±o}-${mes.toString().padStart(2, '0')}`;
    const clave = `${periodo}-Semana${semanaDelMes}`;
    
    if (!reportesPorSemana[clave]) {
      reportesPorSemana[clave] = {
        periodo,
        semana: semanaDelMes,
        a√±o,
        mes,
        nombreMes: fechaNomina.toLocaleDateString('es-MX', { month: 'long' }),
        nominas: [],
        totalNominas: 0,
        totalMonto: 0,
        totalPagado: 0,
        totalPendiente: 0,
        empleados: new Set()
      };
    }
    
    const montoTotal = parseFloat(nomina.monto_total || nomina.monto || 0);
    const montoPagado = parseFloat(nomina.monto_pagado || 0);
    const montoPendiente = montoTotal - montoPagado;
    
    reportesPorSemana[clave].nominas.push(nomina);
    reportesPorSemana[clave].totalNominas++;
    reportesPorSemana[clave].totalMonto += montoTotal;
    reportesPorSemana[clave].totalPagado += montoPagado;
    reportesPorSemana[clave].totalPendiente += montoPendiente;
    reportesPorSemana[clave].empleados.add(nomina.id_empleado);
  });

  // Convertir a array y ordenar
  const reportesArray = Object.values(reportesPorSemana).map(reporte => ({
    ...reporte,
    totalEmpleados: reporte.empleados.size,
    empleados: Array.from(reporte.empleados)
  }));

  // Ordenar por a√±o, mes y semana
  reportesArray.sort((a, b) => {
    if (a.a√±o !== b.a√±o) return b.a√±o - a.a√±o; // M√°s recientes primero
    if (a.mes !== b.mes) return b.mes - a.mes;
    return b.semana - a.semana;
  });

  // Calcular totales generales
  const totalesGenerales = reportesArray.reduce((totales, reporte) => {
    return {
      totalNominas: totales.totalNominas + reporte.totalNominas,
      totalMonto: totales.totalMonto + reporte.totalMonto,
      totalPagado: totales.totalPagado + reporte.totalPagado,
      totalPendiente: totales.totalPendiente + reporte.totalPendiente,
      totalEmpleados: Math.max(totales.totalEmpleados, reporte.totalEmpleados)
    };
  }, {
    totalNominas: 0,
    totalMonto: 0,
    totalPagado: 0,
    totalPendiente: 0,
    totalEmpleados: 0
  });

  setWeeklyReportsData({
    reportes: reportesArray,
    totales: totalesGenerales,
    periodosDisponibles: [...new Set(nominas.map(n => {
      const fecha = new Date(n.fecha_creacion || n.createdAt || n.fecha);
      return `${fecha.getFullYear()}-${(fecha.getMonth() + 1).toString().padStart(2, '0')}`;
    }))].sort().reverse(),
    a√±osDisponibles: [...new Set(nominas.map(n => {
      const fecha = new Date(n.fecha_creacion || n.createdAt || n.fecha);
      return fecha.getFullYear();
    }))].sort((a, b) => b - a)
  });
};
```

### **Mejora 4: Interfaz de Usuario Completa**
```javascript
// ‚úÖ Filtros de navegaci√≥n
<div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label>A√±o</label>
      <select value={selectedYear} onChange={(e) => {
        setSelectedYear(parseInt(e.target.value));
        setSelectedPeriod('');
      }}>
        <option value="">Todos los a√±os</option>
        {weeklyReportsData?.a√±osDisponibles?.map(a√±o => (
          <option key={a√±o} value={a√±o}>{a√±o}</option>
        ))}
      </select>
    </div>
    <div>
      <label>Per√≠odo Espec√≠fico</label>
      <select value={selectedPeriod} onChange={(e) => {
        setSelectedPeriod(e.target.value);
        if (e.target.value) {
          const [a√±o] = e.target.value.split('-');
          setSelectedYear(parseInt(a√±o));
        }
      }}>
        <option value="">Todos los per√≠odos</option>
        {weeklyReportsData?.periodosDisponibles?.map(periodo => (
          <option key={periodo} value={periodo}>{periodo}</option>
        ))}
      </select>
    </div>
    <div>
      <button onClick={() => {
        setSelectedPeriod('');
        setSelectedYear(new Date().getFullYear());
      }}>
        Limpiar Filtros
      </button>
    </div>
  </div>
</div>

// ‚úÖ Tarjetas de totales generales
<div className="grid grid-cols-1 md:grid-cols-4 gap-4">
  <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
    <div className="flex items-center">
      <DocumentTextIcon className="h-8 w-8 text-blue-600 dark:text-blue-400" />
      <div className="ml-4">
        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Total N√≥minas</p>
        <p className="text-2xl font-semibold text-gray-900 dark:text-white">
          {weeklyReportsData.totales.totalNominas}
        </p>
      </div>
    </div>
  </div>
  
  <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
    <div className="flex items-center">
      <CurrencyDollarIcon className="h-8 w-8 text-green-600 dark:text-green-400" />
      <div className="ml-4">
        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Monto Total</p>
        <p className="text-2xl font-semibold text-gray-900 dark:text-white">
          {formatCurrency(weeklyReportsData.totales.totalMonto)}
        </p>
      </div>
    </div>
  </div>
  
  <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
    <div className="flex items-center">
      <CheckCircleIcon className="h-8 w-8 text-green-600 dark:text-green-400" />
      <div className="ml-4">
        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Total Pagado</p>
        <p className="text-2xl font-semibold text-gray-900 dark:text-white">
          {formatCurrency(weeklyReportsData.totales.totalPagado)}
        </p>
      </div>
    </div>
  </div>
  
  <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
    <div className="flex items-center">
      <ClockIcon className="h-8 w-8 text-orange-600 dark:text-orange-400" />
      <div className="ml-4">
        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Total Pendiente</p>
        <p className="text-2xl font-semibold text-gray-900 dark:text-white">
          {formatCurrency(weeklyReportsData.totales.totalPendiente)}
        </p>
      </div>
    </div>
  </div>
</div>

// ‚úÖ Tabla detallada por semanas
<table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
  <thead className="bg-gray-50 dark:bg-gray-700">
    <tr>
      <th>Per√≠odo</th>
      <th>Semana</th>
      <th>N√≥minas</th>
      <th>Empleados</th>
      <th>Monto Total</th>
      <th>Pagado</th>
      <th>Pendiente</th>
    </tr>
  </thead>
  <tbody>
    {weeklyReportsData?.reportes?.map((reporte, index) => (
      <tr key={`${reporte.periodo}-${reporte.semana}`}>
        <td>{reporte.periodo}</td>
        <td>Semana {reporte.semana}</td>
        <td>{reporte.totalNominas}</td>
        <td>{reporte.totalEmpleados}</td>
        <td>{formatCurrency(reporte.totalMonto)}</td>
        <td className="text-green-600">{formatCurrency(reporte.totalPagado)}</td>
        <td className="text-orange-600">{formatCurrency(reporte.totalPendiente)}</td>
      </tr>
    ))}
  </tbody>
</table>
```

## üìä **Resultado Esperado**

### **‚úÖ Despu√©s**
```
Reportes de N√≥minas
‚îú‚îÄ‚îÄ Resumen Semanal
‚îú‚îÄ‚îÄ Gr√°ficas
‚îú‚îÄ‚îÄ Lista de Pagos
‚îú‚îÄ‚îÄ Reportes por Semanas ‚Üê NUEVA
‚îÇ   ‚îú‚îÄ‚îÄ [Filtros: A√±o | Per√≠odo | Limpiar]
‚îÇ   ‚îú‚îÄ‚îÄ [Totales: N√≥minas | Monto | Pagado | Pendiente]
‚îÇ   ‚îî‚îÄ‚îÄ [Tabla: Per√≠odo | Semana | N√≥minas | Empleados | Monto | Pagado | Pendiente]
‚îî‚îÄ‚îÄ Tabla Detallada
```

**Beneficios:**
- ‚úÖ **Agrupaci√≥n por semanas** del mes
- ‚úÖ **Filtros por a√±o** y per√≠odo espec√≠fico
- ‚úÖ **Totales generales** consolidados
- ‚úÖ **Tabla detallada** con desglose por semana
- ‚úÖ **Navegaci√≥n f√°cil** entre muchos meses
- ‚úÖ **Ordenamiento** por fecha (m√°s recientes primero)

## üéØ **Beneficios de la Mejora**

### **‚úÖ Navegaci√≥n Eficiente**
- **Filtro por a√±o**: Ver todos los meses de un a√±o espec√≠fico
- **Filtro por per√≠odo**: Ver un mes espec√≠fico (ej: 2025-10)
- **Bot√≥n limpiar**: Resetear filtros f√°cilmente
- **Ordenamiento**: M√°s recientes primero

### **‚úÖ Informaci√≥n Detallada**
- **Por semana**: Ver desglose de cada semana del mes
- **Totales por semana**: N√≥minas, empleados, montos
- **Estado de pagos**: Pagado vs Pendiente por semana
- **Totales generales**: Resumen de todos los datos filtrados

### **‚úÖ Usabilidad Mejorada**
- **Interfaz intuitiva** con filtros claros
- **Tarjetas de resumen** con iconos y colores
- **Tabla responsive** para diferentes pantallas
- **Estados vac√≠os** cuando no hay datos

### **‚úÖ Consistencia**
- **Mismo algoritmo** de c√°lculo de semanas que el wizard
- **Misma l√≥gica** de fechas y per√≠odos
- **Coherencia** en toda la aplicaci√≥n

## üß™ **Para Probar**

1. **Ve a Reportes de N√≥minas**
2. **Selecciona la pesta√±a** "Reportes por Semanas"
3. **Prueba los filtros**:
   - ‚úÖ Filtrar por a√±o (ej: 2025)
   - ‚úÖ Filtrar por per√≠odo espec√≠fico (ej: 2025-10)
   - ‚úÖ Limpiar filtros
4. **Verifica la tabla**:
   - ‚úÖ Datos agrupados por semana
   - ‚úÖ Totales correctos por semana
   - ‚úÖ Ordenamiento por fecha
   - ‚úÖ Colores para pagado/pendiente

## üìà **Estado del Sistema**

**‚úÖ COMPLETAMENTE IMPLEMENTADO**

- **Nueva pesta√±a**: "Reportes por Semanas" agregada
- **Filtros**: Por a√±o y per√≠odo espec√≠fico
- **C√°lculos**: Agrupaci√≥n por semanas del mes
- **Totales**: Generales y por semana
- **Tabla**: Detallada con desglose completo
- **UI**: Interfaz intuitiva y responsive

**El sistema ahora permite navegar f√°cilmente a trav√©s de muchos meses de datos de n√≥minas, con un desglose detallado por semanas del mes.**

## üîç **Ejemplos de Uso**

### **Ver todas las semanas de 2025**
```
1. Seleccionar a√±o: "2025"
2. Resultado: Todas las semanas de todos los meses de 2025
```

### **Ver solo octubre 2025**
```
1. Seleccionar per√≠odo: "2025-10"
2. Resultado: Solo las semanas de octubre 2025
```

### **Ver resumen general**
```
1. Sin filtros (todos los datos)
2. Resultado: Todas las semanas de todos los per√≠odos
```

**La mejora proporciona una herramienta poderosa para el an√°lisis y consulta de n√≥minas por semanas, facilitando la gesti√≥n de datos hist√≥ricos.**
